var VideoFrame=function(e){if(this===window)return new VideoFrame(e);this.obj=e||{},this.frameRate=this.obj.frameRate||24,this.video=document.getElementById(this.obj.id)||document.getElementsByTagName("video")[0]},FrameRates={film:24,NTSC:29.97,NTSC_Film:23.98,NTSC_HD:59.94,PAL:25,PAL_HD:50,web:30,high:60};VideoFrame.prototype={get:function(){return Math.floor(this.video.currentTime.toFixed(5)*this.frameRate)},listen:function(t,e){var i=this;t?this.interval=setInterval(function(){if(!i.video.paused&&!i.video.ended){var e="SMPTE"===t?i.toSMPTE():"time"===t?i.toTime():i.get();return i.obj.callback&&i.obj.callback(e,t),e}},e||1e3/i.frameRate/2):console.log("VideoFrame: Error - The listen method requires the format parameter.")},stopListen:function(){clearInterval(this.interval)},fps:FrameRates},VideoFrame.prototype.toTime=function(e){function t(e){return e<10?"0"+e:e}var i="number"!=typeof e?this.video.currentTime:e,a=this.frameRate,r=new Date;return e="hh:mm:ss"+("number"==typeof e?":ff":""),r.setHours(0),r.setMinutes(0),r.setSeconds(0),r.setMilliseconds(1e3*i),e.replace(/hh|mm|ss|ff/g,function(e){switch(e){case"hh":return t(r.getHours()<13?r.getHours():r.getHours()-12);case"mm":return t(r.getMinutes());case"ss":return t(r.getSeconds());case"ff":return t(Math.floor(i%1*a))}})},VideoFrame.prototype.toSMPTE=function(e){if(!e)return this.toTime(this.video.currentTime);e=Number(e);var t=this.frameRate,i=60*t,a=(e/(3600*t)).toFixed(0),r=(i=Number((e/i).toString().split(".")[0])%60,Number((e/t).toString().split(".")[0])%60);return(a<10?"0"+a:a)+":"+(i<10?"0"+i:i)+":"+(r<10?"0"+r:r)+":"+(e%t<10?"0"+e%t:e%t)},VideoFrame.prototype.toSeconds=function(e){return e?(e=e.split(":"),3600*Number(e[0])+60*Number(e[1])+Number(e[2])):Math.floor(this.video.currentTime)},VideoFrame.prototype.toMilliseconds=function(e){var t=e?Number(e.split(":")[3]):Number(this.toSMPTE().split(":")[3]);t=1e3/this.frameRate*(isNaN(t)?0:t);return Math.floor(1e3*this.toSeconds(e)+t)},VideoFrame.prototype.toFrames=function(e){e=e?e.split(":"):this.toSMPTE().split(":");var t=this.frameRate;return Math.floor(3600*Number(e[0])*t+60*Number(e[1])*t+Number(e[2])*t+Number(e[3]))},VideoFrame.prototype.__seek=function(e,t){this.video.paused||this.video.pause();var i=Number(this.get());this.video.currentTime=("backward"===e?i-t:i+t)/this.frameRate+1e-5},VideoFrame.prototype.seekForward=function(e,t){return e||(e=1),this.__seek("forward",Number(e)),!t||t()},VideoFrame.prototype.seekBackward=function(e,t){return e||(e=1),this.__seek("backward",Number(e)),!t||t()},VideoFrame.prototype.seekTo=function(e){e=e||{};var t,i=Object.keys(e)[0];if("SMPTE"==i||"time"==i)t=e[i],t=this.toMilliseconds(t)/1e3+.001,this.video.currentTime=t;else{switch(i){case"frame":t=this.toSMPTE(e[i]),t=this.toMilliseconds(t)/1e3+.001;break;case"seconds":t=Number(e[i]);break;case"milliseconds":t=Number(e[i])/1e3+.001}isNaN(t)||(this.video.currentTime=t)}};var viewport,video,demoMovieFile="",fps=25,timeDisplayModes=[$(".time-current"),$(".time-remaining"),$(".frame-current")],displayModeIndex=0;function generateMetadataObject(){var e=$("#metadata"),t={metadata:[]};t.screenshotFields=e.data("screenshotfields").split(",");for(var i=0;i<e.children().length;i++)e.children()[i].value.length&&(t.metadata[e.children()[i].id]=e.children()[i].value);return t}function resizeVideoCanvas(){var e,t,i;e=$(".document-view"),t=$(".mediaplayer-container"),(i=$("video")).css({width:"100%",height:"auto"}),t.height()>e.height()&&i.css({width:"80%",height:"auto"})}function bindPlayerFunctions(){$(".button-settings").bind("click",function(){toggleSettingsMenu()}),$(".button-nextframe").bind("click",function(){frameForward()}),$(".button-lastframe").bind("click",function(){frameBackward()}),$(".button-backward").bind("click",function(){backward()}),$(".button-forward").bind("click",function(){forward()}),$(".time-counters").bind("click",function(){toggleTimeDisplayMode()}),bindSettingsMenuItems(),bindSpeedSettings(),viewport.bind($.jPlayer.event.timeupdate,function(e){$(".time-current").text(getFormattedVideoCurrentTime()),$(".frame-current").text(video.get()),$(".time-remaining").text("-"+$.jPlayer.convertTime(e.jPlayer.status.duration-e.jPlayer.status.currentTime)),resizeVideoCanvas()}),viewport.bind($.jPlayer.event.canplay,function(e){generateChapters(),$(".time-current").text(getFormattedVideoCurrentTime()),$(".frame-current").text(video.get()),$(".time-remaining").text("-"+$.jPlayer.convertTime(e.jPlayer.status.duration-e.jPlayer.status.currentTime))}),viewport.bind($.jPlayer.event.loadeddata,function(e){getParams(document.URL).timecode&&viewport.jPlayer("pause",parseFloat(getParams(document.URL).timecode)),resizeVideoCanvas()})}function bindSettingsMenuItems(){$("#mediaplayer-viewport").contextmenu(function(e){e.preventDefault(),toggleSettingsMenu()}),$(".menu-item-back").bind("click",function(){$(".viewport-menu").children().hide(),$(".settings-menu").show("fast")}),$(".settings-menu-item-speed-menu").bind("click",function(){$(".settings-menu").hide(),$(".speed-menu").show("fast")}),$(".settings-menu-item-quality-menu").bind("click",function(){$(".settings-menu").hide(),$(".quality-menu").show("fast")}),$(".settings-menu-item-subtitle").bind("click",function(){$(".settings-menu").hide(),$(".subtitle-menu").show("fast")}),$(".settings-menu-item-language").bind("click",function(){$(".settings-menu").hide(),$(".language-menu").show("fast")}),$(".settings-menu-item-help").bind("click",function(){$(".viewport-menu").hide(),$(".dfgplayer-help").show("fast")}),$(".settings-menu-item-screenshot").bind("click",function(){renderScreenshot()}),$(".settings-menu-item-url").click(function(e){$(".viewport-menu").hide(),generateUrl()}),$(".modal-close").bind("click",function(){$(".dfgplayer-help").hide("fast")})}function bindSpeedSettings(){$(".speed-menu").children().each(function(){$(this).data("speed")&&$(this).bind("click",function(){viewport.jPlayer("option","playbackRate",$(this).data("speed")),$(".speed-label").text($(this).data("speed")+"x"),$(".viewport-menu").children().hide(),$(".settings-menu").show()})})}function bindKeyboardEvents(){$(document).keydown(function(e){switch(e.keyCode){case 13:e.altKey&&viewport.data("jPlayer").options.fullScreen?viewport.jPlayer("option","fullScreen",!1):viewport.jPlayer("option","fullScreen",!0);break;case 32:viewport.data("jPlayer").status.paused?viewport.jPlayer("play"):viewport.jPlayer("pause");break;case 37:!0===e.shiftKey?backward():frameBackward();break;case 39:!0===e.shiftKey?forward():frameForward();break;case 72:toggleHelp();break;case 77:viewport.data("jPlayer").options.muted?viewport.jPlayer("option","muted",!1):viewport.jPlayer("option","muted",!0);break;case 112:e.preventDefault(),toggleHelp();break;case 187:toggleVolumeBar(),viewport.jPlayer("option","volume",viewport.data("jPlayer").options.volume+.1);break;case 189:toggleVolumeBar(),viewport.jPlayer("option","volume",viewport.data("jPlayer").options.volume-.1)}})}function initializePlayer(){viewport.jPlayer({ready:function(){$(this).jPlayer("setMedia",{m4v:demoMovieFile})},backgroundColor:"#000000",supplied:"m4v",swfPath:"/typo3conf/ext/dlf/Resources/Public/Javascript/jPlayer/jquery.jplayer.swf",size:{width:"100%",height:"auto"},cssSelectorAncestor:".media-viewport",cssSelector:{videoPlay:".button-play",play:".button-play",pause:".button-pause",stop:".button-stop",seekBar:".jp-seek-bar",playBar:".jp-play-bar",mute:".button-mute",unmute:".button-unmute",volumeBar:".jp-volume-bar",volumeBarValue:".jp-volume-bar-value",volumeMax:".jp-volume-max",playbackRateBar:".jp-playback-rate-bar",playbackRateBarValue:".jp-playback-rate-bar-value",currentTime:".jp-current-time",duration:".jp-duration",title:".jp-title",fullScreen:".button-fullscreen",restoreScreen:".button-minimize",repeat:".jp-repeat",repeatOff:".jp-repeat-off",gui:".control-bars",noSolution:".jp-no-solution"}}),viewport.jPlayer("load"),video=VideoFrame({id:"jp_video_0",frameRate:fps,callback:function(e){console.log("callback response: "+e)}})}function generateChapters(){var t=getMediaLength(),i=$(".jp-seek-bar");$(".chapter").each(function(){var e=$(this).data("timecode");$(this).data("title");$("<span />",{class:"jp-chapter-marker",title:$(this).data("title"),style:"position: absolute; left: "+100*(e-.5)/t+"%",click:function(){play(e)}}).appendTo(i)})}function generateUrl(){var e=document.URL,t=$("#url-field"),i=$("#url-container");e=getParams(e)?e+"&timecode="+viewport.data("jPlayer").status.currentTime:e+"?timecode="+viewport.data("jPlayer").status.currentTime,t.val(e),i.show("fast")}function toggleSettingsMenu(){var e=$(".viewport-menu");e.children().hide(),$(".settings-menu").show(),e.toggle("fast")}function getMediaLength(){return viewport.data("jPlayer").status.duration}function frameForward(){viewport.data("jPlayer").status.currentTime<viewport.data("jPlayer").status.duration&&video.seekForward(1)}function frameBackward(){0<viewport.data("jPlayer").status.currentTime&&video.seekBackward(1)}function forward(){viewport.data("jPlayer").status.currentTime+10<viewport.data("jPlayer").status.duration&&viewport.jPlayer("play",viewport.data("jPlayer").status.currentTime+10)}function backward(){0<viewport.data("jPlayer").status.currentTime-10&&viewport.jPlayer("play",viewport.data("jPlayer").status.currentTime-10)}function play(e){viewport.jPlayer("play",e)}function toggleHelp(){var e=$(".dfgplayer-help");"none"===e.css("display")?e.show("fast"):e.hide("fast")}function toggleVolumeBar(){var e=$(".jp-volume-bar");e.css({visibility:"visible",opacity:1}),setTimeout(function(){e.css({visibility:"hidden",opacity:0})},3e3)}function renderScreenshot(){toggleSettingsMenu();var e=$("<div id='screenshot-overlay'><span class='close-screenshot-modal icon-close'></span><canvas id='screenshot-canvas'></canvas></div>");$("body").append(e),$(".close-screenshot-modal").bind("click",function(){$("#screenshot-overlay").detach()}),drawCanvas()}function drawCanvas(){var e,t,i,a=[],r="";e=document.getElementById("jp_video_0"),t=document.getElementById("screenshot-canvas");for(var n=this.generateMetadataObject(),o=0;o<n.screenshotFields.length;o++)"string"==typeof n.metadata[n.screenshotFields[o]]&&a.push(n.metadata[n.screenshotFields[o]]);for(o=0;o<a.length;o++)a.length-1!==o?r+=a[o]+" / ":r+=a[o];t.width=e.videoWidth,t.height=e.videoHeight,(i=t.getContext("2d")).drawImage(e,0,0,t.width,t.height),i.font="25px Arial",i.textAlign="end",i.fillStyle="#FFFFFF",i.shadowBlur=5,i.shadowColor="black",i.fillText(r,t.width-10,t.height-10),t.style.width="80%",t.style.height="auto"}function toggleTimeDisplayMode(){for(var e=0;e<timeDisplayModes.length;e++)timeDisplayModes[e].css("display","none");displayModeIndex<timeDisplayModes.length?(timeDisplayModes[displayModeIndex].css("display","block"),displayModeIndex++):(displayModeIndex=0,toggleTimeDisplayMode())}function getFormattedVideoCurrentTime(){var e=viewport.data("jPlayer").status;return(e.currentTime<3600?"00:":"")+$.jPlayer.convertTime(e.currentTime)+":"+("0"+video.get()%fps).slice(-2)}$(document).ready(function(){var e=$(".mime-type-video");demoMovieFile=$(".mime-type-video").data("url"),e&&0<e.length&&(viewport=$("#mediaplayer-viewport"),initializePlayer(),bindPlayerFunctions(),bindKeyboardEvents(),resizeVideoCanvas(),toggleTimeDisplayMode())}),$(window).resize(function(){resizeVideoCanvas()});